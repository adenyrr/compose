name: llm-openwebui

services:
  open-webui:
    image: ghcr.io/open-webui/open-webui:main
    container_name: open-webui
    ports:
      - "3721:8080"
    volumes:
      - open-webui:/app/backend/data
      - /sys/fs/cgroup:/sys/fs/cgroup:ro
    environment:
      # Database
      DATABASE_URL: "postgresql://${PG_USER:-openwebui}:${PG_PASS}@postgres:5432/openwebui"
      DATABASE_POOL_SIZE: "15"
      DATABASE_POOL_MAX_OVERFLOW: "20"
      DATABASE_ENABLE_SESSION_SHARING: "true"
      
      # Vector DB
      VECTOR_DB: "qdrant"
      QDRANT_URI: "http://qdrant:6333"
      ENABLE_QDRANT_MULTITENANCY_MODE: "true"
      
      # Cache
      REDIS_URL: "redis://redis:6379/0"
      ENABLE_BASE_MODELS_CACHE: "true"
      MODELS_CACHE_TTL: "300"
      ENABLE_QUERIES_CACHE: "true"
      
      # Performance
      THREAD_POOL_SIZE: "2000"
      ENABLE_REALTIME_CHAT_SAVE: "false"
      CHAT_RESPONSE_STREAM_DELTA_CHUNK_SIZE: "7"
      
      # RAG
      RAG_SYSTEM_CONTEXT: "true"
      CHUNK_MIN_SIZE_TARGET: "1000"
      TIKA_SERVER_URL: "http://tika:9998"
      
      # Features
      ENABLE_IMAGE_GENERATION: "false"
      ENABLE_CODE_INTERPRETER: "true"
      ENABLE_AUTOCOMPLETE_GENERATION: "false"
      ENABLE_FOLLOW_UP_GENERATION: "true"
      ENABLE_TITLE_GENERATION: "true"
      ENABLE_TAGS_GENERATION: "true"
    cap_add: 
      - SYS_ADMIN
      - SYS_CHROOT
      - SYS_PTRACE
      - NET_ADMIN
    security_opt:
      - apparmor:unconfined      
    depends_on:
      postgres:
        condition: service_healthy
      qdrant:
        condition: service_started
      redis:
        condition: service_healthy
      tika:
        condition: service_started
    restart: always
    networks:
      - llm-network

  postgres:
    image: postgres:16-alpine
    container_name: openwebui-postgres
    environment:
      POSTGRES_DB: openwebui
      POSTGRES_USER: ${PG_USER:-openwebui}
      POSTGRES_PASSWORD: ${PG_PASS}
      POSTGRES_INITDB_ARGS: "-E UTF8 --locale=C"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    # Ports exposés uniquement si accès externe nécessaire
    # ports:
    #   - "5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${PG_USER:-openwebui} -d openwebui"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: always
    networks:
      - llm-network

  qdrant:
    image: qdrant/qdrant:latest
    container_name: openwebui-qdrant
    # Ports exposés uniquement si accès externe nécessaire
    # ports:
    #   - "6333:6333"
    #   - "6334:6334"
    volumes:
      - qdrant_storage:/qdrant/storage
    environment:
      QDRANT__SERVICE__API_KEY: "${QDRANT_API_KEY}"
      QDRANT__SERVICE__GRPC_PORT: "6334"
    restart: always
    networks:
      - llm-network

  redis:
    image: redis:7-alpine
    container_name: openwebui-redis
    # Ports exposés uniquement si accès externe nécessaire
    # ports:
    #   - "6379:6379"
    volumes:
      - redis_data:/data
    command: redis-server --appendonly yes --maxmemory 512mb --maxmemory-policy allkeys-lru
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5
    restart: always
    networks:
      - llm-network

  mcpo:
    image: ghcr.io/open-webui/mcpo:main
    container_name: mcpo
    ports:
      - "3722:8000"
    command: ["mcpo", "--config", "/config/mcpo_config.json"]
    volumes:
      - ./mcpo_config.json:/config/mcpo_config.json:ro
    restart: always
    networks:
      - llm-network

  tika:
    image: apache/tika:latest-full
    container_name: tika
    # Port interne uniquement
    # ports:
    #   - "9998:9998"
    restart: unless-stopped
    networks:
      - llm-network

volumes:
  open-webui:
    driver: local
  postgres_data:
    driver: local
  qdrant_storage:
    driver: local
  redis_data:
    driver: local

networks:
  llm-network:
    external: true