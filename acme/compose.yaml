services:
  traefik:
    image: traefik:v2.11
    container_name: traefik
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    ports:
      - "80:80"
      - "443:443"
    environment:
      - TZ=Europe/Brussels
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - traefik-data:/letsencrypt
      - traefik-certs:/certs
    command:
      # Pas de dashboard
      - --api.dashboard=false
      
      # Providers
      - --providers.docker=true
      - --providers.docker.exposedbydefault=false
      - --providers.docker.network=traefik
      
      # Entrypoints
      - --entrypoints.web.address=:80
      - --entrypoints.websecure.address=:443
      
      # Redirection HTTP vers HTTPS
      - --entrypoints.web.http.redirections.entrypoint.to=websecure
      - --entrypoints.web.http.redirections.entrypoint.scheme=https
      
      # Configuration ACME avec step-ca
      - --certificatesresolvers.stepca.acme.email=${STEP_ADMIN_EMAIL}
      - --certificatesresolvers.stepca.acme.storage=/letsencrypt/acme.json
      - --certificatesresolvers.stepca.acme.caserver=https://step-ca:9000/acme/${STEP_PROVISIONER_NAME}/directory
      - --certificatesresolvers.stepca.acme.httpchallenge=true
      - --certificatesresolvers.stepca.acme.httpchallenge.entrypoint=web
      
      # Accepter les certificats auto-sign√©s de step-ca (pour l'initialisation)
      - --serversTransport.insecureSkipVerify=true
      
      # Logs
      - --log.level=INFO
      - --accesslog=true
    networks:
      - traefik
      - step-internal
    depends_on:
      step-ca:
        condition: service_healthy

  step-ca:
    image: smallstep/step-ca:latest
    container_name: step-ca
    restart: unless-stopped
    environment:
      - DOCKER_STEPCA_INIT_NAME=${STEP_CA_NAME}
      - DOCKER_STEPCA_INIT_DNS_NAMES=${STEP_CA_DNS},step-ca,localhost
      - DOCKER_STEPCA_INIT_PROVISIONER_NAME=${STEP_PROVISIONER_NAME}
      - DOCKER_STEPCA_INIT_ADMIN_SUBJECT=${STEP_ADMIN_EMAIL}
      - DOCKER_STEPCA_INIT_PASSWORD=${STEP_CA_PASSWORD}
      - DOCKER_STEPCA_INIT_ACME=true
      - DOCKER_STEPCA_INIT_SSH=true
    volumes:
      - step-ca-data:/home/step
    networks:
      - traefik
      - step-internal
    security_opt:
      - no-new-privileges:true
    tmpfs:
      - /tmp
    healthcheck:
      test: ["CMD", "step", "ca", "health", "--ca-url=https://localhost:9000", "--root=/home/step/certs/root_ca.crt"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    labels:
      # Traefik pour step-ca
      - "traefik.enable=true"
      - "traefik.http.routers.step-ca.rule=Host(`${STEP_CA_DNS}`)"
      - "traefik.http.routers.step-ca.entrypoints=websecure"
      - "traefik.http.routers.step-ca.tls=true"
      - "traefik.http.routers.step-ca.tls.certresolver=stepca"
      - "traefik.http.services.step-ca.loadbalancer.server.port=9000"
      

networks:
  traefik:
    driver: bridge
    name: traefik
  step-internal:
    driver: bridge
    ipam:
      config:
        - subnet: 172.28.0.0/16

volumes:
  step-ca-data:
    driver: local
  traefik-data:
    driver: local
  traefik-certs:
    driver: local